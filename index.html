<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë¼ë©´ ë¹„ì„œ</title>
<style>
  :root{
    --bg:#0b1220;
    --panel:#0f172a;
    --card:#111827;
    --muted:#334155;
    --txt:#e2e8f0;
    --me:#22c55e;
    --accent:#38bdf8;
    --header-h:56px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--txt);
    font-family:Pretendard,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    display:flex;justify-content:center;
  }
  .app{
    width:100%;max-width:720px;min-height:100dvh;
    display:flex;flex-direction:column;
  }
  header{
    padding:12px 16px;background:var(--card);
    border-bottom:1px solid #1f2937;
    position:sticky;top:0;z-index:5;
  }
  header h1{margin:0;font-size:18px;line-height:1.2}

  .chat{
    flex:1;overflow:auto;
    padding:16px 12px 210px;
    background:var(--panel);
  }
  .msg{display:flex;margin:10px 0}
  .msg .bubble{
    max-width:78%;
    background:var(--muted);
    padding:12px 14px;border-radius:16px;line-height:1.45;
  }
  .msg.me{justify-content:flex-end}
  .msg.me .bubble{background:var(--me);color:#0b1220}

  footer{
    position:fixed;left:0;right:0;bottom:0;
    background:var(--bg);
    border-top:1px solid #1f2937;
    padding:10px 8px;
  }
  .inputbar{
    max-width:720px;margin:0 auto;
    display:flex;gap:8px;
  }
  input{
    flex:1;padding:10px 12px;border-radius:12px;
    border:1px solid var(--muted);
    background:var(--bg);color:var(--txt);
    font-size:13px;
  }
  button{
    padding:10px 16px;border-radius:12px;border:0;
    background:var(--me);color:#0b1220;font-weight:700;
    cursor:pointer;font-size:13px;
  }

  /* ìƒë‹¨ ì„ íƒ ì˜ì—­ */
  .picker{
    padding:8px 12px;background:#0b1220;
    border-bottom:1px solid #1f2937;
    position:sticky;top:var(--header-h);z-index:4;
  }
  .row{display:flex;flex-wrap:wrap;gap:8px}
  .chip{
    margin:4px 0;padding:8px 12px;border-radius:999px;
    border:1px solid var(--muted);
    background:transparent;color:var(--txt);
    cursor:pointer;font-size:13px;
  }
  .chip:hover{background:#0f172a}
  .chip.active{background:#0f172a}

  .chips-box .chip{
    padding:6px 10px;font-size:12px;
  }

  .dots{display:inline-block;width:1.5em;text-align:left}
  .dots::after{content:'â€¦';animation:blink 1s steps(1) infinite}
  @keyframes blink{50%{opacity:.3}}

  .ctrls{
    display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;
  }
  .ctrls button{
    padding:7px 12px;font-size:12px;border-radius:999px;
    border:1px solid var(--muted);
    background:transparent;color:var(--txt);
    cursor:pointer;
  }
  .ctrls button:hover{background:#0f172a}

  .meter{
    height:6px;background:#0b1220;
    border:1px solid #1f2937;
    border-radius:999px;overflow:hidden;
    margin-top:8px;
  }
  .meter>i{display:block;height:100%;background:var(--accent);width:0%}

  .muted{opacity:.8}
  .hidden{display:none!important}

  /* Sticky mini timer */
  .sticky-timer{
    position:fixed;left:0;right:0;bottom:78px;margin:auto;max-width:720px;
    display:flex;align-items:center;gap:12px;
    background:var(--card);color:var(--txt);
    border:1px solid #1f2937;border-radius:14px;
    padding:10px 14px;z-index:6;
    box-shadow:0 4px 20px rgba(0,0,0,.3);font-size:13px;
  }
  .sticky-timer.hidden{display:none!important}
  .sticky-timer .name{font-weight:700}
  .sticky-timer .left{
    font-variant-numeric:tabular-nums;
    min-width:52px;text-align:right;
  }
  .sticky-timer .meter{flex:1;height:6px;margin:0 4px}
  .sticky-timer .mini-btn{
    padding:8px 12px;font-size:12px;border-radius:999px;
    border:1px solid var(--muted);
    background:transparent;color:var(--txt);
    cursor:pointer;
  }
  .sticky-timer .mini-btn:hover{background:#0f172a}

  /* ëª¨ë°”ì¼ ìµœì í™” */
  @media (max-width:480px){
    header{padding:10px 10px;}
    header h1{font-size:16px;}
    .picker{padding:6px 8px;}
    .chat{padding:10px 8px 180px;}
    .msg .bubble{
      max-width:82%;
      padding:10px 11px;
      font-size:13px;
    }
    .chip{
      padding:6px 10px;
      font-size:12px;
    }
    footer{padding:8px 6px;}
    .inputbar{gap:6px;}
    input{
      padding:9px 10px;
      font-size:12px;
    }
    button{
      padding:9px 12px;
      font-size:12px;
    }
    .sticky-timer{
      bottom:70px;
      padding:8px 10px;
      gap:8px;
      font-size:12px;
    }
    .sticky-timer .mini-btn{
      padding:6px 8px;
      font-size:11px;
    }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <h1>ğŸœ ë¼ë©´ AI ë¹„ì„œ</h1>
      <!-- ì–¸ì–´ í† ê¸€ -->
      <div id="langToggle"
           style="display:flex;gap:4px;font-size:12px;background:#020617;border-radius:999px;padding:2px;border:1px solid #1f2937">
        <button data-lang="ko"
                style="border:0;background:transparent;color:#e5e7eb;padding:4px 10px;border-radius:999px;cursor:pointer;font-size:12px">
          KR
        </button>
        <button data-lang="en"
                style="border:0;background:transparent;color:#9ca3af;padding:4px 10px;border-radius:999px;cursor:pointer;font-size:12px">
          EN
        </button>
      </div>
    </div>
  </header>

  <div class="picker">
    <div id="brandLabel" style="font-size:13px;opacity:.8;margin-bottom:6px">
      ë¸Œëœë“œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”
    </div>

    <div id="brandRow" class="row"></div>

    <div id="ramenBlock" style="margin-top:10px;display:none">
      <div style="font-size:13px;opacity:.8;margin-bottom:6px">
        <span id="brandTitle"></span>
        <span id="ramenLabelText"> ë¼ë©´ ì„ íƒ</span>
      </div>
      <div id="ramenRow" class="row"></div>
    </div>
  </div>

  <div id="chat" class="chat"></div>

  <footer>
    <div class="inputbar">
      <input id="inp" placeholder="ì˜ˆ: ì‹ ë¼ë©´ 4:30 / ì»µë¼ë©´ 3ë¶„ì¸ë° 2ë¶„50ì´ˆë§Œ" />
      <button id="send">ì „ì†¡</button>
    </div>
  </footer>
</div>

<!-- sticky mini timer -->
<div id="stickyTimer" class="sticky-timer hidden">
  <span class="name">ë¼ë©´</span>
  <span class="left">0:00</span>
  <div class="meter"><i></i></div>
  <button id="stExtend"  class="mini-btn">+1ë¶„</button>
  <button id="stStop"    class="mini-btn">ì •ì§€</button>
  <button id="stCancel"  class="mini-btn">ì·¨ì†Œ</button>
  <button id="stRestart" class="mini-btn hidden">ì¬ì‹œì‘</button>
</div>

<audio id="ding">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA" type="audio/mp3">
</audio>

<script>
/* DOM */
const chat   = document.getElementById('chat');
const inp    = document.getElementById('inp');
const sendBtn= document.getElementById('send');
const ding   = document.getElementById('ding');

const brandRow  = document.getElementById('brandRow');
const ramenBlock= document.getElementById('ramenBlock');
const ramenRow  = document.getElementById('ramenRow');
const brandTitle= document.getElementById('brandTitle');
const ramenLabelText = document.getElementById('ramenLabelText');
const brandLabel = document.getElementById('brandLabel');

/* sticky */
const sticky   = document.getElementById('stickyTimer');
const stName   = sticky.querySelector('.name');
const stLeft   = sticky.querySelector('.left');
const stBar    = sticky.querySelector('.meter > i');
const stExtend = document.getElementById('stExtend');
const stStop   = document.getElementById('stStop');
const stCancel = document.getElementById('stCancel');
const stRestart= document.getElementById('stRestart');
const langToggle = document.getElementById('langToggle');
const headerEl = document.querySelector('header');

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ í—¤ë” ë†’ì´ì— ë§ì¶° picker ê°„ê²© ë§ì¶”ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateHeaderHeight(){
  if(!headerEl) return;
  const h = headerEl.getBoundingClientRect().height;
  document.documentElement.style.setProperty('--header-h', h + 'px');
}

/* ì–¸ì–´ í† ê¸€ í™œì„±/ë¹„í™œì„± */
function setLangToggleDisabled(disabled){
  if(!langToggle) return;
  if(disabled){
    langToggle.style.pointerEvents = 'none';
    langToggle.style.opacity = '0.4';
  }else{
    langToggle.style.pointerEvents = '';
    langToggle.style.opacity = '1';
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ë‹¤êµ­ì–´ í…ìŠ¤íŠ¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
const copy = {
  ko: {
    header: 'ğŸœ ë¼ë©´ AI ë¹„ì„œ',
    pickerBrandLabel: 'ë¸Œëœë“œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”',
    pickerRamenKeyword: 'ë¼ë©´ ì„ íƒ',
    inputPlaceholder: 'ì˜ˆ: ì‹ ë¼ë©´ 4:30 / ì»µë¼ë©´ 3ë¶„ì¸ë° 2ë¶„50ì´ˆë§Œ',
    firstMessage: 'ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ğŸœ ë¼ë©´ AI ë¹„ì„œì˜ˆìš”. ë¨¼ì € <b>ë¸Œëœë“œ</b>ë¥¼ ê³ ë¥´ê±°ë‚˜, ì•„ë˜ì— â€œì‹ ë¼ë©´ 4:30â€ì²˜ëŸ¼ ë§í•´ë³´ì„¸ìš”.',
    stickyName: 'ë¼ë©´',
    miniExtend: '+1ë¶„',
    miniStop: 'ì •ì§€',
    miniCancel: 'ì·¨ì†Œ',
    miniRestart: 'ì¬ì‹œì‘',
    ctrlStop: 'ì •ì§€',
    ctrlCancel: 'ì·¨ì†Œ',
    ctrlExtend: 'ë“ì´ëŠ” ë°©ë²•',
    ctrlChange: 'ë¼ë©´ ë°”ê¾¸ê¸°',
    timerStatusStart: 'íƒ€ì´ë¨¸ ì‹œì‘ â€” ',
    timerStatusLeft: 'ë‚¨ì€ ì‹œê°„',
    timerPaused: 'ì •ì§€í–ˆì–´ìš”',
    timerCanceled: 'ì·¨ì†Œí–ˆì–´ìš”',
    timerChange: 'ë³€ê²½í•©ë‹ˆë‹¤',
    timerDone: 'ë‹¤ ëì–´ìš”! ë¶ˆê¸° ì „ì— ê±´ì ¸ìš” ğŸœ',
    errorServer: 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜ âŒ',
    sendLabel: 'ì „ì†¡'
  },
  en: {
    header: 'ğŸœ Ramen AI Assistant',
    pickerBrandLabel: 'Choose your ramen brand',
    pickerRamenKeyword: 'Select ramen',
    inputPlaceholder: 'e.g. Shin Ramyun 4:30 / Cup noodle 3 minutes â†’ 2:50',
    firstMessage: 'Hi! Iâ€™m your ğŸœ Ramen AI Assistant. Pick a <b>brand</b> above, or type something like â€œShin Ramyun 4:30â€.',
    stickyName: 'Ramen',
    miniExtend: '+1 min',
    miniStop: 'Pause',
    miniCancel: 'Cancel',
    miniRestart: 'Restart',
    ctrlStop: 'Pause',
    ctrlCancel: 'Cancel',
    ctrlExtend: 'How to cook',
    ctrlChange: 'Change ramen',
    timerStatusStart: 'Timer started â€” ',
    timerStatusLeft: 'time left',
    timerPaused: 'Paused',
    timerCanceled: 'Canceled',
    timerChange: 'Changing ramen',
    timerDone: 'Done! Take the noodles out ğŸœ',
    errorServer: 'Server connection error âŒ',
    sendLabel: 'Send'
  }
};

/* ë¸Œëœë“œ / ë¼ë©´ í‘œê¸° ë³€í™˜ */
const brandLabelMap = {
  ko: { 'ë†ì‹¬':'ë†ì‹¬','ì‚¼ì–‘':'ì‚¼ì–‘','ì˜¤ëšœê¸°':'ì˜¤ëšœê¸°','íŒ”ë„':'íŒ”ë„' },
  en: { 'ë†ì‹¬':'Nongshim','ì‚¼ì–‘':'Samyang','ì˜¤ëšœê¸°':'Ottogi','íŒ”ë„':'Paldo' }
};

const ramenLabelMap = {
  ko: {},
  en: {
    'ì‹ ë¼ë©´':'Shin Ramyun',
    'ì‹ ë¼ë©´ ë¸”ë™':'Shin Ramyun Black',
    'ì–¼í° ë„ˆêµ¬ë¦¬':'Spicy Neoguri',
    'ë„ˆêµ¬ë¦¬':'Neoguri',
    'ì•ˆì„±íƒ•ë©´':'Ansungtangmyun',
    'í•´ë¬¼ ì•ˆì„±íƒ•ë©´':'Seafood Ansungtangmyun',
    'ì§œíŒŒê²Œí‹°':'Chapagetti',
    'ë§ˆë¼ì§œíŒŒê²Œí‹°':'Mara Chapagetti',
    'ë°°í™ë™ë¹„ë¹”ë©´':'Bae Hong Dong Bibim',
    'ë°°í™ë™ì¹¼ë¹”ë©´':'Bae Hong Dong Spicy Bibim',
    'ì‚¬ë¦¬ë©´':'Sari Ramyun',
    'ë¬´íŒŒë§ˆ':'Mupama',
    'ê±´ë©´':'Non-fried Noodles',
    'ì˜¤ì§•ì–´ì§¬ë½•':'Squid Jjamppong',
    'ë‘¥ì§€ëƒ‰ë©´':'Nest Cold Noodles',
    'ëƒ‰ë©´':'Cold Noodles',
    'ì§¬ë½•ë©´':'Jjamppong Noodles',
    'í•´ë¬¼ì§¬ë½•':'Seafood Jjamppong',
    'ë©”ë°€ì†Œë°”':'Buckwheat Soba',
    'ê¹€ì¹˜ì‚¬ë°œë©´':'Kimchi Bowl Noodles',
    'ìœ¡ê°œì¥ì‚¬ë°œë©´':'Yukgaejang Bowl Noodles',
    'ì‹ ë¼ë©´ íˆ¼ë°”':'Shin Ramyun Tumba',
    'ë¶ˆë‹­ë³¶ìŒë©´':'Buldak Stir-fried',
    'ê¹Œë¥´ë³´ë¶ˆë‹­':'Carbonara Buldak',
    'ì¹˜ì¦ˆë¶ˆë‹­':'Cheese Buldak',
    'ì‚¼ì–‘ë¼ë©´':'Samyang Ramyun',
    'ë‚˜ê°€ì‚¬í‚¤ ì§¬ë½•':'Nagasaki Jjamppong',
    'ë§›ìˆê²Œ ë§¤ìš´ë©´':'Tasty Spicy Noodles',
    'ë§µíƒ±ë©´':'MaepTaeng Noodles',
    'ì§„ë¼ë©´(ë§¤ìš´ë§›)':'Jin Ramen (Spicy)',
    'ì§„ë¼ë©´(ìˆœí•œë§›)':'Jin Ramen (Mild)',
    'ì—´ë¼ë©´':'Yeol Ramen',
    'ì°¸ê¹¨ë¼ë©´':'Sesame Ramen',
    'ê¹€ì¹˜ë¼ë©´':'Kimchi Ramen',
    'ì§„ì§¬ë½•':'Jin Jjamppong',
    'ì§„ì§œì¥':'Jin Jjajang',
    'ì‡ ê³ ê¸°ë¼ë©´':'Beef Ramen',
    'ë¶ì—‡êµ­ë¼ë©´':'Dried Pollack Soup Ramen',
    'ì»µëˆ„ë“¤':'Cup Noodle (Low-cal)',
    'ë¼ë©´ì‚¬ë¦¬':'Ramen Noodles (Extra)',
    'ë¹„ë¹”ë©´':'Paldo Bibim Men',
    'ì™•ëšœê»‘':'King Lid Cup',
    'ê¼¬ê¼¬ë©´':'Kkokko Men',
    'í‹ˆìƒˆë¼ë©´':'Teumsae Ramen',
    'UP ì»µì™•ëšœê»‘':'UP King Lid Cup',
    'ë¼ë³¶ì´':'Rabokki',
    'ë‚¨ìë¼ë©´':'Namja Ramen'
  }
};

let currentLang = localStorage.getItem('ramenLang') || 'ko';

/* ë§¤ìš´ë§› í‘œì‹œìš© */
function isSpicyName(name=''){
  return /(ë§¤ìš´|ë§¤ìš´ë§›|ë¶ˆë‹­|ë¶ˆ|ì—´ë¼ë©´|í‹ˆìƒˆ|ë§µíƒ±|Spicy)/i.test(name);
}

/* ì–¸ì–´ ì ìš© */
function applyLang(){
  const c = copy[currentLang] || copy.ko;

  document.querySelector('header h1').textContent = c.header;
  brandLabel.textContent = c.pickerBrandLabel;
  ramenLabelText.textContent = ' ' + c.pickerRamenKeyword;

  inp.placeholder = c.inputPlaceholder;
  sendBtn.textContent = c.sendLabel;

  stName.textContent   = c.stickyName;
  stExtend.textContent = c.miniExtend;
  stStop.textContent   = c.miniStop;
  stCancel.textContent = c.miniCancel;
  stRestart.textContent= c.miniRestart;

  // ì–¸ì–´ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼
  langToggle.querySelectorAll('button').forEach(btn=>{
    if(btn.dataset.lang === currentLang){
      btn.style.background = '#0f172a';
      btn.style.color = '#e5e7eb';
    }else{
      btn.style.background = 'transparent';
      btn.style.color = '#9ca3af';
    }
  });

  // ë¸Œëœë“œ/ë¼ë©´ ì¹© ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  if (CATALOG){
    renderBrands();
    if (SELECTED_BRAND){
      renderRamen(SELECTED_BRAND);
    }
  }

  const welcome = document.querySelector('.msg[data-role="welcome"] .bubble');
  if (welcome){
    welcome.innerHTML = c.firstMessage;
  }

  updateHeaderHeight();
}

function setLang(lang){
  // íƒ€ì´ë¨¸ ì§„í–‰/ì¼ì‹œì •ì§€ ì¤‘ì´ë©´ ë³€ê²½ ê¸ˆì§€
  if(currentTimer || pausedSnapshot) return;
  currentLang = lang === 'en' ? 'en' : 'ko';
  localStorage.setItem('ramenLang', currentLang);
  applyLang();
}
langToggle.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click',()=>setLang(btn.dataset.lang));
});

/* Sticky timer helpers */
function showSticky(name){ stName.textContent=name; sticky.classList.remove('hidden'); }
function hideSticky(){ sticky.classList.add('hidden'); }
function formatMMSS(sec){
  const m = Math.floor(sec/60), s = sec%60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function updateSticky(leftSec,totalSec){
  const per = totalSec>0 ? (1-leftSec/totalSec)*100 : 100;
  stLeft.textContent = formatMMSS(leftSec);
  stBar.style.width = Math.max(0,Math.min(100,per)) + '%';
}

/* ì±„íŒ… ë©”ì‹œì§€ */
function addMsg(html, who='bot'){
  const w = document.createElement('div');
  w.className = `msg ${who}`;
  w.innerHTML = `<div class="bubble">${html}</div>`;
  chat.appendChild(w);
  chat.scrollTop = chat.scrollHeight;
  return w;
}
function typing(on=true){
  let t = document.getElementById('typing');
  if(on){
    if(t) return;
    const w = document.createElement('div');
    w.className = 'msg'; w.id = 'typing';
    w.innerHTML = `<div class="bubble"><span class="dots"></span></div>`;
    chat.appendChild(w);
  }else t?.remove();
  chat.scrollTop = chat.scrollHeight;
}
function renderChips(items=[]){
  if(!items.length) return;
  const box = addMsg(
    `<div class="chips-box">${items.map(s=>`<button class="chip">${s}</button>`).join(' ')}</div>`
  );
  box.querySelectorAll('.chip').forEach(btn=>{
    btn.onclick = ()=>{
      const txt = btn.textContent.trim();
      inp.value = txt;
      sendBtn.click();
    };
  });
}

/* API í˜¸ì¶œ */
async function apiParse(text){
  const r = await fetch('/api/parse',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ text, lang: currentLang })
  });
  const data = await r.json();
  if(!r.ok) throw new Error(data?.error || 'server');
  return data;
}

/* íƒ€ì´ë¨¸ ìƒíƒœ */
let currentTimer = null;
let lastTimerPreset = null;
let pausedSnapshot  = null;

function hideActiveCtrls(b){
  b.querySelector('#btnStop')?.classList.add('hidden');
  b.querySelector('#btnCancel')?.classList.add('hidden');
  b.querySelector('#btnChange')?.classList.add('hidden');
  b.querySelector('#btnExtend')?.classList.add('hidden');
}
function showRestartCtrls(b){
  const ctrls = b.querySelector('.ctrls');
  let btn = ctrls.querySelector('#btnRestart');
  if(!btn){
    btn = document.createElement('button');
    btn.id = 'btnRestart';
    btn.textContent = copy[currentLang]?.miniRestart || 'ì¬ì‹œì‘';
    btn.onclick = doRestartFromSnapshot;
    ctrls.prepend(btn);
  }else btn.classList.remove('hidden');
}

function updateCountdown(){
  if(!currentTimer) return;
  const now  = Date.now();
  const left = Math.max(0, Math.round((currentTimer.endAt - now)/1000));
  const total= currentTimer.secsTotal;
  const status = currentTimer.bubbleEl.querySelector('.status');
  const bar    = currentTimer.bubbleEl.querySelector('.meter > i');
  const c = copy[currentLang] || copy.ko;

  status.innerHTML = `â±ï¸ <b>${currentTimer.name}</b> ${c.timerStatusLeft} <b>${formatMMSS(left)}</b>`;
  const per = Math.max(0,Math.min(100,(1-left/total)*100));
  bar.style.width = per + '%';

  updateSticky(left,total);

  if(left <= 0) finishTimer();
  else currentTimer.tickHandle = setTimeout(updateCountdown,250);
}

/* ë“ì´ëŠ” ë°©ë²• ë¶ˆëŸ¬ì˜¤ê¸° */
async function showGuideFor(name){
  typing(true);
  try {
    const r = await fetch(
      `/api/guide?name=${encodeURIComponent(name)}&lang=${currentLang}`
    );
    const data = await r.json();
    typing(false);

    const isEn = currentLang === 'en';
    const title = `<b>${data.title || name}</b>`;
    const steps = (data.steps || []).join('<br>');
    const notes = (data.notes && data.notes.length)
      ? `<br><span class="muted">${isEn ? 'Tip) ' : 'íŒ) '}${data.notes.join(' Â· ')}</span>`
      : '';

    addMsg(`${title}<br>${steps}${notes}`);
  } catch (e) {
    typing(false);
    const c = copy[currentLang] || copy.ko;
    addMsg(c.errorServer);
  }
}

function pauseTimer(){
  if(!currentTimer) return;
  const now  = Date.now();
  const left = Math.max(0, Math.round((currentTimer.endAt - now)/1000));
  const total= currentTimer.secsTotal;
  pausedSnapshot = { name: currentTimer.name, left, total };

  clearTimeout(currentTimer.handle);
  clearTimeout(currentTimer.tickHandle);

  const b = currentTimer.bubbleEl;
  const c = copy[currentLang] || copy.ko;
  b.querySelector('.status').innerHTML = `â¸ï¸ <b>${currentTimer.name}</b> ${c.timerPaused}`;
  hideActiveCtrls(b); showRestartCtrls(b);

  updateSticky(left,total);
  stStop.classList.add('hidden');
  stExtend.classList.add('hidden');
  stCancel.classList.remove('hidden');
  stRestart.classList.remove('hidden');

  currentTimer = null;
}

function cancelTimerHard(reasonKey='defaultCancel'){
  const c = copy[currentLang] || copy.ko;
  const msg = reasonKey === 'change' ? c.timerChange : c.timerCanceled;

  if(currentTimer){
    clearTimeout(currentTimer.handle);
    clearTimeout(currentTimer.tickHandle);
    const b = currentTimer.bubbleEl;
    b.querySelector('.status').innerHTML = `â›” <b>${currentTimer.name}</b> ${msg}`;
    hideActiveCtrls(b);
  }
  currentTimer = null;
  pausedSnapshot = null;
  hideSticky();

  stStop.classList.remove('hidden');
  stExtend.classList.remove('hidden');
  stRestart.classList.add('hidden');

  if(!currentTimer && !pausedSnapshot){
    setLangToggleDisabled(false);
  }
}

function extendTimer(sec=60){
  if(!currentTimer) return;
  const now = Date.now();
  currentTimer.endAt = Math.max(now,currentTimer.endAt) + sec*1000;
  currentTimer.secsTotal += sec;
  clearTimeout(currentTimer.tickHandle);
  updateCountdown();
}

function finishTimer(){
  if(!currentTimer) return;
  const c = copy[currentLang] || copy.ko;
  addMsg(`âœ… <b>${currentTimer.name}</b> ${c.timerDone}`);
  try{ ding.currentTime=0; ding.play().catch(()=>{});}catch(e){}
  updateSticky(0,1);
  stStop.classList.add('hidden');
  stExtend.classList.add('hidden');
  stRestart.classList.remove('hidden');
  pausedSnapshot = null;
  currentTimer = null;

  if(!currentTimer && !pausedSnapshot){
    setLangToggleDisabled(false);
  }
}

function startTimer(name,seconds){
  if(currentTimer) cancelTimerHard('change');

  lastTimerPreset = { name, seconds };
  const c = copy[currentLang] || copy.ko;

  const b = addMsg(`
    <div class="status muted">â±ï¸ <b>${name}</b> ${c.timerStatusStart}${formatMMSS(seconds)}</div>
    <div class="meter"><i></i></div>
    <div class="ctrls">
      <button id="btnStop">${c.ctrlStop}</button>
      <button id="btnCancel">${c.ctrlCancel}</button>
      <button id="btnExtend">${c.ctrlExtend}</button>
      <button id="btnChange">${c.ctrlChange}</button>
    </div>
  `);
  // ë²„íŠ¼ ìˆœì„œ: ì •ì§€ â†’ ì·¨ì†Œ â†’ ë“ì´ëŠ” ë°©ë²• â†’ ë¼ë©´ ë°”ê¾¸ê¸°
  b.querySelector('#btnStop').onclick   = ()=>pauseTimer();
  b.querySelector('#btnCancel').onclick = ()=>cancelTimerHard();
  b.querySelector('#btnExtend').onclick = ()=>showGuideFor(name);
  b.querySelector('#btnChange').onclick = ()=>{
    cancelTimerHard('change');
    window.scrollTo({top:0,behavior:'smooth'});
  };

  const endAt = Date.now() + seconds*1000;
  currentTimer = {
    id:Math.random().toString(36).slice(2),
    name,endAt,
    handle:setTimeout(()=>finishTimer(),seconds*1000),
    bubbleEl:b,secsTotal:seconds,tickHandle:null
  };

  showSticky(name);
  stExtend.onclick = ()=>extendTimer(60);
  stStop.onclick   = ()=>pauseTimer();
  stCancel.onclick = ()=>cancelTimerHard();
  stRestart.onclick= ()=>doRestartFromSnapshot();

  stRestart.classList.add('hidden');
  stStop.classList.remove('hidden');
  stExtend.classList.remove('hidden');
  stCancel.classList.remove('hidden');

  setLangToggleDisabled(true);
  updateCountdown();
}

function doRestartFromSnapshot(){
  const name = (pausedSnapshot?.name) || (lastTimerPreset?.name) || (copy[currentLang]?.stickyName || 'ë¼ë©´');
  const sec  = (pausedSnapshot?.left ?? lastTimerPreset?.seconds ?? 180);
  pausedSnapshot = null;
  startTimer(name,sec);
}

/* ì…ë ¥ ì²˜ë¦¬ */
async function handleUser(text){
  // ë¡œì»¬ì—ì„œë„ ìµœì†Œí•œì˜ ì·¨ì†Œ/ì •ì§€/ì¬ì‹œì‘ ì¸í…íŠ¸ ì²˜ë¦¬(ì„œë²„ ì˜¤ë¥˜ ëŒ€ë¹„)
  const cancelIntentLocal = /(íƒ€ì´ë¨¸ ?(ì·¨ì†Œ|êº¼)|ì·¨ì†Œí•´ì¤˜|íƒ€ì´ë¨¸ êº¼ì¤˜|cancel (the )?timer|stop (the )?timer)/i.test(text);
  const pauseIntentLocal  = /(íƒ€ì´ë¨¸ ?(ì •ì§€|ì¼ì‹œì •ì§€)|ë©ˆì¶°ì¤˜|ì ê¹ ë©ˆì¶°|pause (the )?timer)/i.test(text);
  const resumeIntentLocal = /(ë‹¤ì‹œ ì‹œì‘|ì¬ì‹œì‘|ê³„ì†í•´|resume (the )?timer|continue (the )?timer)/i.test(text);

  if (cancelIntentLocal) cancelTimerHard();
  else if (pauseIntentLocal) pauseTimer();
  else if (resumeIntentLocal) doRestartFromSnapshot();

  addMsg(text,'me');
  typing(true);
  try{
    const d = await apiParse(text);
    typing(false);

    if(d.reply) addMsg(d.reply);
    if(Array.isArray(d.suggestions) && d.suggestions.length){
      renderChips(d.suggestions.slice(0,4));
    }

    // ì„œë²„ê°€ ë‚´ë ¤ì¤€ íƒ€ì´ë¨¸ ì œì–´
    if (d.control) {
      if (d.control === 'cancel') {
        cancelTimerHard();
      } else if (d.control === 'pause') {
        pauseTimer();
      } else if (d.control === 'resume') {
        doRestartFromSnapshot();
      }
    }

    if(d.should_start && d?.name && d?.seconds){
      startTimer(d.name,d.seconds);
    }
  }catch(e){
    typing(false);
    const c = copy[currentLang] || copy.ko;
    addMsg(c.errorServer);
  }
}
sendBtn.onclick = ()=>{
  const t = inp.value.trim();
  if(!t) return;
  handleUser(t);
  inp.value='';
};
inp.addEventListener('keydown',e=>{
  if(e.key==='Enter') sendBtn.click();
});

/* ë¸Œëœë“œ/ë¼ë©´ ë Œë” */
let CATALOG = null;
let SELECTED_BRAND = null;

function renderBrands(){
  brandRow.innerHTML = '';
  const labels = brandLabelMap[currentLang] || {};
  Object.keys(CATALOG).forEach(b=>{
    const btn = document.createElement('button');
    btn.className = 'chip';
    btn.textContent = labels[b] || b;
    if(SELECTED_BRAND === b) btn.classList.add('active');
    btn.onclick = ()=>{
      if(SELECTED_BRAND === b && ramenBlock.style.display !== 'none'){
        ramenBlock.style.display='none';
        SELECTED_BRAND=null;
        [...brandRow.children].forEach(c=>c.classList.remove('active'));
        return;
      }
      SELECTED_BRAND = b;
      renderBrands();
      renderRamen(b);
      ramenBlock.style.display='block';
    };
    brandRow.appendChild(btn);
  });
}

function renderRamen(b){
  ramenBlock.style.display='block';
  const brandLabels = brandLabelMap[currentLang] || {};
  brandTitle.textContent = brandLabels[b] || b;

  const ramenLabels = ramenLabelMap[currentLang] || {};
  ramenRow.innerHTML='';

  const items = CATALOG[b];

  items.forEach(it=>{
    const displayName = ramenLabels[it.name] || it.name;
    const spicy = isSpicyName(it.name);
    const btn = document.createElement('button');
    btn.className = 'chip';
    // âœ… ì´ë¦„ë§Œ + ë§µê¸° ì•„ì´ì½˜ (ì‹œê°„ ì œê±°)
    btn.textContent = `${displayName}${spicy ? ' ğŸŒ¶ï¸' : ''}`;
    btn.onclick = ()=>handleUser(`${it.name} ${it.time}`);
    ramenRow.appendChild(btn);
  });
}

/* ì¹´íƒˆë¡œê·¸ ë¡œë”© */
async function loadCatalog(){
  try{
    const r = await fetch('/api/catalog');
    const { catalog } = await r.json();
    CATALOG = catalog;
    renderBrands();
  }catch(e){
    console.error(e);
  }
}

/* ì´ˆê¸°í™” */
applyLang();
const welcomeMsg = addMsg(copy[currentLang].firstMessage);
welcomeMsg.dataset.role = 'welcome';

loadCatalog();
updateHeaderHeight();
window.addEventListener('resize',updateHeaderHeight);
setLangToggleDisabled(false);
</script>
</body>
</html>
